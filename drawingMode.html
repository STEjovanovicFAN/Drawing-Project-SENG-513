<!DOCTYPE html>
<html>
  <head>
    <title>Drawing Page</title>
    <!--reference the 2 javascript files that this html page will use-->
    <!--<script src="fabric.js"></script>-->
    <style>
          #cont {
      position: relative;
      width: 500px;
      height: 500px;
      }

      canvas {
      border: 1px solid;
      }

      #cont canvas, .canvas-container {
      position: absolute!important;
      left: 0!important;
      top: 0!important;
      width: 100%!important;
      height: 100%!important;
      }

      #cursor {
      pointer-events: none!important;
      }
    </style>

    <!-- add jquery-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.2.2/fabric.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  </head>
  <body>
    <!--color of the brush -->
    Color: <input id="color" type="color" value="#000000"><br/>
    <!--size of the brush -->
    Brush size: <input id="size" type="range" min="1" max="100" step="1" value="20"><br/>

    <!--canvas with cursor -->
    <div id="cont">
      <canvas id="draw" width="500" height="500"></canvas>
      <canvas id="cursor" width="500" height="500"></canvas>
    </div>
    <h1>Your word is: <span id = word>null</span></h1>
    <h1>Time left: <span id = time> </span></h1>

    <script>
      var socket = io();
      var word;
      socket.emit('getDrawingWord');

      //listen for a responce from server for the word you have to draw
      socket.on('recvWord', function(responce){
        word = responce;
        document.getElementById("word").innerHTML = word;
      });

      //get the current time left from the server and display it
      socket.on('send current time', function(currentTime){
        //console.log(currentTime);
        document.getElementById("time").innerHTML = currentTime;
      });

      //set the new canvas to be able to draw
      var canvas = new fabric.Canvas("draw", {
      	isDrawingMode: true,
        freeDrawingCursor: 'none'
      });

      //get the cursor
      var cursor = new fabric.StaticCanvas("cursor");

      //initalize the brushes width and color
      canvas.freeDrawingBrush.width = 20;
      canvas.freeDrawingBrush.color = '#000000';

      //set cursorOpacity to 50%
      var cursorOpacity = .5;
      //make the mousecursor a circle with the below attributes
      var mousecursor = new fabric.Circle({
        left: -100,
        top: -100,
        radius: canvas.freeDrawingBrush.width / 2,
        fill: "rgba(196,196,196," + cursorOpacity + ")",
        stroke: "black",
        originX: 'center',
        originY: 'center'
      });

      //add the cursor to the canvas
      cursor.add(mousecursor);

      //when the mouse moves
      canvas.on('mouse:move', function (evt) {
      	var mouse = this.getPointer(evt.e);
        mousecursor
        	.set({
            top: mouse.y,
            left: mouse.x
          })
          .setCoords()
      	  .canvas.renderAll();
      });

      canvas.on('mouse:out', function () {
        // put circle off screen
        mousecursor
        	.set({
            top: -100,//mousecursor.originalState.top,
            left: -100 //mousecursor.originalState.left
          })
          .setCoords()
          .canvas.renderAll();
      });

      canvas.on('mouse:up', function(){
        //console.log(JSON.stringify(canvas));
        socket.emit('push data', JSON.stringify(canvas));
      });

      //while brush size is changed
      document.getElementById("size").oninput = function () {
      	var size = this.value;
        mousecursor
        	.center()
        	.set({
            radius: size/2
        	})
          .setCoords()
          .canvas.renderAll();
      };

      //after brush size has been changed
      document.getElementById("size").onchange = function () {
      	var size = parseInt(this.value, 10);
        canvas.freeDrawingBrush.width = size;
        mousecursor
        	.set({
            //left: mousecursor.originalState.left,
            //top: mousecursor.originalState.top,
            radius: size/2
        	})
          .setCoords()
          .canvas.renderAll();
      };

      //change drawing color
      document.getElementById("color").onchange = function () {
      	canvas.freeDrawingBrush.color = this.value;
        var bigint = parseInt(this.value.replace("#", ""), 16);
        var r = (bigint >> 16) & 255;
        var g = (bigint >> 8) & 255;
        var b = bigint & 255;
        //mousecursor.fill = "rgba(" + [r,g,b,cursorOpacity].join(",") + ")";
      };
    </script>

  </body>
</html>
